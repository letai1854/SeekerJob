
@using SeekerJob.Controllers
@using SeekerJob.DataSystem
@{
    var jobuser = ViewData["jobuser"] as SeekerJob.DTO.CombineJobUser;
    var listjob = ViewData["listjobuser"] as List<SeekerJob.DTO.CombineJobUser>;
    var relativeTime = data.GetRelativeTime((DateTime)jobuser.job.startday);
    var idjob = jobuser.job.id;
    bool check = ViewData["check"] != null ? (bool)ViewData["check"] : false;
}


@{
    ViewBag.Title = "ViewJobDetail";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .custom-file-upload {
        border: 2px dashed #ddd;
        padding: 15px;
        text-align: center;
        margin-bottom: 10px;
        background: #f9f9f9;
        cursor: pointer;
    }

    .selected-file {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: #f5f5f5;
        border-radius: 4px;
        margin-top: 10px;
        border: 1px solid #e0e0e0;
    }

    .btn-remove-file {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #ff4444;
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
        margin-left: 10px;
    }

        .btn-remove-file:hover {
            background: #cc0000;
            transform: scale(1.1);
        }

    .file-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 80%;
    }
</style>
<div class="page-content" style="margin-top:-100px; ">

    <!-- INNER PAGE BANNER -->
    <div class="wt-bnr-inr overlay-wraper bg-center" style="background-image:url(jobzilla/images/banner/1.jpg);">
        <div class="overlay-main site-bg-white opacity-01"></div>
        <div class="container">
            <div class="wt-bnr-inr-entry">
                <div class="banner-title-outer">
                    <div class="banner-title-name">
                        <h2 class="wt-title">@jobuser.job.title</h2>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- INNER PAGE BANNER END -->
    <!-- OUR BLOG START -->
    <div class="section-full  p-t120 p-b90" style="background-color: rgb(230, 230, 230);">
        <div class="container">

            <!-- BLOG SECTION START -->
            <div class="section-content">
                <div class="row d-flex justify-content-center">

                    <div class="col-lg-8 col-md-12" style="background-color: white; padding:10px">
                        <!-- Candidate detail START -->
                        <div class="cabdidate-de-info">
                            <div class="twm-job-self-wrap">
                                <div class="twm-job-self-info">
                                    <div class="twm-job-self-top">
                                        <div class="twm-media-bg">
                                            <img src="~/ContentImage/images/@jobuser.job.image" alt="#" style="width:600px; height:350px">
                                            <div class="twm-jobs-category green"><span class="twm-bg-green">Mới</span></div>
                                        </div>


                                        <div class="twm-mid-content">

                                            <div class="twm-media">
                                                <img src="~/ContentImage/images/@jobuser.employer.image" alt="#">
                                            </div>

                                            <h4 class=@jobuser.job.title <span class="twm-job-post-duration">@relativeTime</span></h4>
                                            <p class="twm-job-address"><i class="feather-map-pin"></i>@jobuser.job.addressdetail</p>
                                            <div class="twm-job-self-mid">
                                                <div class="twm-job-self-mid-left">
                                                    <a href="@jobuser.employer.linkweb" class="twm-job-websites site-text-primary">@jobuser.employer.linkweb</a>
                                                    <div class="twm-jobs-amount">@jobuser.job.offer$/ Tháng</div>
                                                </div>
                                                <div class="twm-job-apllication-area">
                                                    Ngày kết thúc
                                                    <span class="twm-job-apllication-date">@jobuser.job.endday</span>
                                                </div>
                                            </div>

                                            <div class="twm-job-self-bottom" style="display: flex; align-items: center; gap: 10px;">
                                                @if (check)
                                                {
                                                        if (Session["candidate"]!=null || Session["admin"] != null)
                                                        {
                                                            <img onclick="savejob()" style="width: 30px; height: 30px; cursor:pointer" src="~/ContentImage/images/icons8-save-50_green.png" />

                                                        }
                                                
                                                    
                                                }
                                                else
                                                {
                                                        if (Session["candidate"] != null || Session["admin"]!=null)
                                                        {
                                                            <img onclick="savejob()" style="width: 30px; height: 30px; cursor:pointer" src="~/ContentImage/images/icons8-save-50_gray.png" />

                                                        }
                                                }
                                                @if (Session["candidate"] != null)
                                                    {

                                                <a class="site-button" href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#apply_job_popup">
                                                    Ứng tuyển ngay
                                                </a>
                                                    }
                                            </div>

                                        </div>
                                    </div>

                                </div>
                            </div>
                            <div>


                                @Html.Raw(jobuser.job.description)


                            </div>

                            <h4 class="twm-s-title">Chia sẻ hồ sơ</h4>
                            <div class="twm-social-tags">
                                <a href="@jobuser.employer.facebook" class="fb-clr">Facebook</a>
                                <a href="@jobuser.employer.twitter" class="tw-clr">Twitter</a>
                                <a href="@jobuser.employer.linkedin" class="pinte-clr">Linkedin</a>
                                <a href="@jobuser.employer.instagram" class="whats-clr">Instagram</a>
                            </div>





                        </div>
                    </div>

                    <div class="col-lg-4 col-md-12 rightSidebar">

                        <div class="side-bar mb-4" style="background-color:#fff">
                            <div class="twm-s-info2-wrap mb-5">
                                <div class="twm-s-info2">
                                    <h4 class="section-head-small mb-4">Thông tin công việc</h4>
                                    <ul class="twm-job-hilites2">

                                        <li>
                                            <div class="twm-s-info-inner">
                                                <i class="fas fa-calendar-alt"></i>
                                                <span class="twm-title">Ngày đăng</span>
                                                <div class="twm-s-info-discription">@jobuser.job.startday</div>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="twm-s-info-inner">
                                                <i class="fas fa-map-marker-alt"></i>
                                                <span class="twm-title">Địa điểm</span>
                                                <div class="twm-s-info-discription">@jobuser.job.address</div>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="twm-s-info-inner">
                                                <i class="fas fa-user-tie"></i>
                                                <span class="twm-title">Tiêu đề công việc</span>
                                                <div class="twm-s-info-discription">@jobuser.job.title</div>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="twm-s-info-inner">
                                                <i class="fas fa-clock"></i>
                                                <span class="twm-title">Kinh nghiệm</span>
                                                @if (jobuser.job.experience > 0)
                                                {
                                                    <div class="twm-s-info-discription">@jobuser.job.experience year</div>

                                                }
                                                else
                                                {
                                                    <div class="twm-s-info-discription">@jobuser.job.experience</div>

                                                }
                                            </div>
                                        </li>
                                        <li>
                                            <div class="twm-s-info-inner">
                                                <i class="fas fa-suitcase"></i>
                                                <span class="twm-title">Trình độ</span>
                                                <div class="twm-s-info-discription">@jobuser.job.degree</div>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="twm-s-info-inner">
                                                <i class="fas fa-venus-mars"></i>
                                                <span class="twm-title">Giới tính</span>
                                                <div class="twm-s-info-discription">@jobuser.job.gender</div>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="twm-s-info-inner">

                                                <i class="fas fa-money-bill-wave"></i>
                                                <span class="twm-title">Mức lương</span>
                                                <div class="twm-s-info-discription">@jobuser.job.offer / Tháng</div>
                                            </div>
                                        </li>

                                    </ul>

                                </div>
                            </div>


                        </div>

                        <div class="twm-s-info3-wrap mb-5">
                            <div class="twm-s-info3">
                                <div class="twm-s-info-logo-section">
                                    <div class="twm-media">
                                        <img src="~/ContentImage/images/@jobuser.employer.image" alt="#">
                                    </div>
                                    <h4 class="twm-title">@jobuser.job.title</h4>
                                </div>
                                <ul>

                                    <li>
                                        <div class="twm-s-info-inner">
                                            <i class="fas fa-building"></i>
                                            <span class="twm-title">Công ty</span>
                                            <div class="twm-s-info-discription">@jobuser.employer.namecompany</div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="twm-s-info-inner">
                                            <i class="fas fa-mobile-alt"></i>
                                            <span class="twm-title">Số điện thoại</span>
                                            <div class="twm-s-info-discription">@jobuser.employer.phone</div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="twm-s-info-inner">
                                            <i class="fas fa-at"></i>
                                            <span class="twm-title">Email</span>
                                            <div class="twm-s-info-discription">@jobuser.employer.email</div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="twm-s-info-inner">
                                            <i class="fas fa-desktop"></i>
                                            <span class="twm-title">Website</span>
                                            <div class="twm-s-info-discription">@jobuser.employer.linkweb</div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="twm-s-info-inner">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span class="twm-title">Đia chỉ</span>
                                            <div class="twm-s-info-discription">@jobuser.employer.adrress</div>
                                        </div>
                                    </li>

                                </ul>
                                <a href="/@ViewBag.metaprofile/@jobuser.employer.username" class=" site-button">Xem hồ sơ</a>

                            </div>
                        </div>




                    </div>

                </div>


            </div>
            <div class="row" style="margin-top:30px">
                <div class="col-8">

                    <h3 style="margin-bottom:10px">Các việc làm liên quan</h3>
                    <div class="col-12">
                        @foreach (var item in listjob)
                        {
                            <div class="col-12 mb-4">
                                <div class="job-card bg-white border p-3 d-flex flex-column align-items-stretch">
                                    <div class="d-flex">
                                        <div class="job-card-image-wrapper position-relative">
                                            <img src="~/ContentImage/images/@item.job.image" alt="job-image" class="job-card-image">
                                        </div>
                                        <div class="twm-mid-content">
                                            <div style="display:flex;">

                                                <a href="/@ViewBag.metacontroller/@item.job.meta/@item.job.id" class="twm-job-title">
                                                    <h4>@item.job.title</h4>
                                                </a>
                                                <p class="twm-job-post-duration" style="margin-right:10px">/@relativeTime</p>
                                                <div style="display:flex; justify-content:flex-end">
                                                    @if (@item.job.jobcategory == EnumType.jobCategory.Fulltime.ToString())
                                                    {
                                                        <div class="twm-jobs-category green"><span class="twm-bg-green">@item.job.jobcategory</span></div>

                                                    }
                                                    @if (@item.job.jobcategory == EnumType.jobCategory.Parttime.ToString())
                                                    {
                                                        <div class="twm-jobs-category golden"><span class="twm-bg-golden">@item.job.jobcategory</span></div>

                                                    }
                                                    @if (@item.job.jobcategory == EnumType.jobCategory.Internship.ToString())
                                                    {
                                                        <div class="twm-jobs-category brown"><span class="twm-bg-brown">@item.job.jobcategory</span></div>

                                                    }
                                                    @if (@item.job.jobcategory == EnumType.jobCategory.Volunteer.ToString())
                                                    {
                                                        <div class="twm-jobs-category "><span class="twm-bg-candi-pattern">@item.job.jobcategory</span></div>

                                                    }
                                                    @if (@item.job.jobcategory == EnumType.jobCategory.Freelance.ToString())
                                                    {
                                                        <div class="twm-jobs-category purple"><span class="twm-bg-purple">@item.job.jobcategory</span></div>

                                                    }
                                                    @if (@item.job.jobcategory == EnumType.jobCategory.Temporary.ToString())
                                                    {
                                                        <div class="twm-jobs-category red"><span class="twm-bg-red">@item.job.jobcategory</span></div>
                                                    }
                                                </div>
                                            </div>
                                            <p class="twm-job-address" style="margin-right:10px">@item.job.addressdetail</p>


                                        </div>

                                    </div>
                                    <div class="twm-right-content" style="display:flex; justify-content:flex-end">

                                        <a href="/@ViewBag.metacontroller/@item.job.meta/@item.job.id" class="twm-jobs-browse site-text-primary">Xem thêm</a>
                                    </div>
                                </div>
                            </div>
                        }

                    </div>
                </div>
            </div>

        </div>

    </div>
    <!-- OUR BLOG END -->

</div>

<div class="modal fade" id="apply_job_popup" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title" id="sign_up_popupLabel">Ứng tuyển công việc</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="apl-job-inpopup">
                    <!--Basic Information-->
                    <div class="panel panel-default">

                        <div class="panel-body wt-panel-body p-a20 ">

                            <div class="twm-tabs-style-1">

                                <div class="row">

                                    <div class="col-lg-12 col-md-12">
                                        <div class="form-group">
                                            <label>Tải hồ sơ</label>
                                            <div class="custom-file-upload">
                                                <input type="file" id="cv-upload" class="form-control" accept=".pdf,.doc,.docx">
                                                <div id="file-name-display"></div>
                                            </div>
                                            <small>
                                                Nếu bạn không có tài liệu sơ yếu lý lịch, bạn có thể viết hồ sơ chuyên môn ngắn gọn của mình <a class="site-text-primary" href="javascript:void(0);">here</a>
                                            </small>
                                        </div>
                                    </div>


                                    <div class="col-xl-12 col-lg-12 col-md-12">
                                        <div class="text-left">
                                            <div onclick="sendfile()" class="site-button">Gửi đơn</div>
                                        </div>
                                    </div>



                                </div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
$(document).ready(function() {
    // Xử lý khi click vào nút ứng tuyển
    $('.site-button[data-bs-toggle="modal"]').click(function(e) {
        e.preventDefault(); // Ngăn chặn chuyển trang
        $('#apply_job_popup').modal('show');
    });

    // Đảm bảo modal được khởi tạo đúng cách
    var applyModal = new bootstrap.Modal(document.getElementById('apply_job_popup'), {
        keyboard: false
    });
});
</script>

<script>
    $(document).ready(function () {
        $('#cv-upload').change(function () {
            var fileName = $(this).val().split('\\').pop();
            if (fileName) {
                $('#file-name-display').html(
                    '<div class="selected-file">' +
                    '<span class="file-name">' + fileName + '</span>' +
                    '<button type="button" class="btn-remove-file" onclick="removeFile()">&times;</button>' +
                    '</div>'
                );
            }
        });
    });

    function removeFile() {
        $('#cv-upload').val('');
        $('#file-name-display').empty();
    }
</script>



<script>
    function sendfile() {
        var file = $('#cv-upload')[0].files[0];
        var id = @idjob;
        flag = true;

        // Kiểm tra file
        if (!file) {
            // Thêm div để hiển thị lỗi nếu chưa có
            if ($('#msfile').length === 0) {
                $('.custom-file-upload').after('<div id="msfile" style="color: red; margin-top: 5px;"></div>');
            }
            $('#msfile').html('Vui lòng chọn file');
            flag = false;
        }

        if (flag) {
            var formData = new FormData();
            formData.append('file', file);
            formData.append('id', id);
            var xhr = new XMLHttpRequest();
            xhr.open("POST", '/JobDetail/UploadCV', true); // Thay đổi đường dẫn API của bạn

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.Data.status == "OK") {
                                alert("Gửi CV thành công!");
                                // Reset form
                                $('#cv-upload').val('');
                                $('#file-name-display').empty();
                            } else {
                                alert("Có lỗi xảy ra: " + response.Data.message);
                            }
                        } catch (e) {
                            alert("Có lỗi xảy ra khi xử lý phản hồi từ server");
                        }
                    } else {
                        alert("Có lỗi xảy ra khi gửi file");
                    }
                }
            };

            // Hiển thị loading nếu cần
            xhr.upload.onprogress = function (event) {
                if (event.lengthComputable) {
                    var percentComplete = (event.loaded / event.total) * 100;
                    // Có thể thêm progress bar ở đây
                }
            };

            xhr.send(formData);
        }
    }

    // Xóa thông báo lỗi khi user chọn file
    $(document).ready(function () {
        $('#cv-upload').change(function () {
            $('#msfile').html('');
        });
    });
</script>

<script>
function savejob() {
    var id = @idjob; // Lấy id từ biến Razor

    $.ajax({
        url: '/JobDetail/SaveJob',
        type: 'POST',
        data: { id: id },
        success: function(response) {
            if (response.Data.status === "OK") {
                var imgElement = $('img[onclick="savejob()"]');
                if (response.Data.saved) {
                    // Nếu đã save thì đổi sang ảnh xanh
                    imgElement.attr('src', '/ContentImage/images/icons8-save-50_green.png');
                } else {
                    // Nếu bỏ save thì đổi sang ảnh xám
                    imgElement.attr('src', '/ContentImage/images/icons8-save-50_gray.png');
                }
            } else if (response.Data.status === "ERROR") {
                if (response.Data.message === "LOGIN_REQUIRED") {
                    alert("Vui lòng đăng nhập để lưu công việc");
                   
                } else {
                    alert(response.Data.message);
                }
            }
        },
        error: function() {
            alert("Có lỗi xảy ra, vui lòng thử lại sau");
        }
    });
}
</script>

